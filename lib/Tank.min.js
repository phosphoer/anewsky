function addProperty(obj,name,onGet,onSet){var oldValue=obj[name],getFn=function(){return onGet.apply(obj,[oldValue])},setFn=function(newValue){return oldValue=onSet.apply(obj,[newValue])};if(Object.defineProperty){Object.defineProperty(obj,name,{get:getFn,set:setFn})}else if(obj.__defineGetter__){obj.__defineGetter__(name,getFn);obj.__defineSetter__(name,setFn)}else{var onPropertyChange=function(e){if(event.propertyName==name){obj.detachEvent("onpropertychange",onPropertyChange);var newValue=setFn(obj[name]);obj[name]=getFn;obj[name].toString=getFn;obj.attachEvent("onpropertychange",onPropertyChange)}};obj[name]=getFn;obj[name].toString=getFn;obj.attachEvent("onpropertychange",onPropertyChange)}}window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(callback,element){window.setTimeout(callback,1e3/60)}}();(function(TANK,undefined){(function(Math,jsMath,undefined){Math.angleToPoint=function(fromPoint,toPoint){return jsMath.atan2(toPoint[1]-fromPoint[1],toPoint[0]-fromPoint[0])};Math.pointDistancePoint=function(pointA,pointB){return jsMath.sqrt((pointA[0]-pointB[0])*(pointA[0]-pointB[0])+(pointA[1]-pointB[1])*(pointA[1]-pointB[1]))};Math.pointInRect=function(point,topLeft,bottomRight){if(point[0]<topLeft[0]||point[1]<topLeft[1])return false;if(point[0]>bottomRight[0]||point[1]>bottomRight[1])return false;return true};Math.pointInCircle=function(point,center,radius){return Math.pointDistancePoint(point,center)<=radius}})(TANK.Math=TANK.Math||{},Math)})(this.TANK=this.TANK||{});(function(TANK){(function(Key){Key.LEFT_MOUSE=0;Key.MIDDLE_MOUSE=1;Key.RIGHT_MOUSE=2;Key.LEFT_ARROW=37;Key.UP_ARROW=38;Key.RIGHT_ARROW=39;Key.DOWN_ARROW=40;Key.SHIFT=16;Key.BACKSPACE=8;Key.ESCAPE=27;Key.SPACE=32;Key.CONTROL=17;Key.ALT=18;Key.SUPER=91;Key.TILDE=192;Key.A=65;Key.B=66;Key.C=67;Key.D=68;Key.E=69;Key.F=70;Key.G=71;Key.H=72;Key.I=73;Key.J=74;Key.K=75;Key.L=76;Key.M=77;Key.N=78;Key.O=79;Key.P=80;Key.Q=81;Key.R=82;Key.S=83;Key.T=84;Key.U=85;Key.V=86;Key.W=87;Key.X=88;Key.Y=89;Key.Z=90;Key.NUM1=49;Key.NUM2=50;Key.NUM3=51;Key.NUM4=52;Key.NUM5=53;Key.NUM6=54;Key.NUM7=55;Key.NUM8=56;Key.NUM9=57;Key.NUM0=48})(TANK.Key=TANK.Key||{})})(this.TANK=this.TANK||{});(function(TANK){"use strict";TANK.Component=function(name){this.name=name;this.parent=null;this._functions={};this._includes=[];this._interfaces=[]};TANK.Component.prototype.clone=function(){var c={};c.construct=function(){};c.initialize=function(){};c.destruct=function(){};c.interfaces={};var i;for(i=0;i<this._interfaces.length;++i){c.interfaces[this._interfaces[i]]=true}for(i in this._functions){if(this._functions.hasOwnProperty(i)){c[i]=this._functions[i]}}c.name=this.name;c._constructed=false;c.addEventListener=this.addEventListener;c.removeEventListener=this.removeEventListener;c._listeners=[];return c};TANK.Component.prototype.requires=function(){var i,j,arg;for(i=0;i<arguments.length;++i){arg=arguments[i];arg=arg.replace(/\s/g,"");var includes=arg.split(",");for(j=0;j<includes.length;++j){this._includes.push(includes[j])}}return this};TANK.Component.prototype.interfaces=function(){var i,j,arg;for(i=0;i<arguments.length;++i){arg=arguments[i];arg=arg.replace(/\s/g,"");var interfaces=arg.split(",");for(j=0;j<interfaces.length;++j){this._interfaces.push(interfaces[i])}}return this};TANK.Component.prototype.construct=function(func){this._functions.construct=func;return this};TANK.Component.prototype.initialize=function(func){this._functions.initialize=func;return this};TANK.Component.prototype.destruct=function(func){this._functions.destruct=func;return this};TANK.Component.prototype.addEventListener=function(event,callback){if(this._functions){TANK.error("The component "+this.name+"tried to listen to "+event+"before it was instantiated.");return}if(!this._constructed){TANK.error("The component "+this.name+" tried to listen to "+event+" from `construct`, but should do so from `initialize` instead");return}if(!callback||!callback.apply){TANK.error("The component "+this.name+" tried to listen to "+event+" but did not supply a valid callback");return}var listeners=this.space._events[event];if(!listeners){listeners=[];this.space._events[event]=listeners}this._listeners.push({evt:event,self:this,func:callback});listeners.push({self:this,func:callback})};TANK.Component.prototype.removeEventListener=function(event,callback){if(this._functions){TANK.error("The component "+this.name+"tried to stop listening to "+event+"before it was instantiated.");return}if(!this._constructed){TANK.error("The component "+this.name+" tried to stop listening to "+event+" from `construct`, but should do so from `initialize` instead");return}if(!callback||!callback.apply){TANK.error("The component "+this.name+" tried to stop listening to "+event+" but did not supply a valid callback");return}var listeners=this.space._events[event],i;if(!listeners){return}for(i=0;i<this._listeners.length;++i){if(this._listeners[i].evt===event&&this._listeners[i].func===callback){this._listeners.splice(i,1);break}}for(i=0;i<listeners.length;++i){if(listeners[i].self===this&&listeners[i].func===callback){listeners.splice(i,1);break}}}})(this.TANK=this.TANK||{});(function(TANK){"use strict";TANK.Entity=function(id){this.name=null;this.id=id;this.space=null;this._components={};this._orderedComponents=[];this._initialized=false;this._numComponents=0};TANK.Entity.prototype.addComponent=function(componentName){if(this[componentName]){return this}var componentDef=TANK._registeredComponents[componentName];if(!componentDef){TANK.error("No component registered with name "+componentName);return this}this[componentName]="Placeholder";this._components[componentName]="Placeholder";var i;for(i=0;i<componentDef._includes.length;++i){this.addComponent(componentDef._includes[i])}var component=componentDef.clone();this[componentName]=component;this._orderedComponents.push(component);this._components[componentName]=component;component.construct();component._constructed=true;component._order=this._numComponents++;component.parent=this;component.space=this.space;if(this._initialized){this.trackInterface(componentName);component.initialize();this.space.dispatchEvent("OnComponentInitialized",component)}return this};TANK.Entity.prototype.addComponents=function(){var i,j,arg;for(i=0;i<arguments.length;++i){arg=arguments[i];arg=arg.replace(/\s/g,"");var components=arg.split(",");for(j=0;j<components.length;++j){this.addComponent(components[j])}}return this};TANK.Entity.prototype.removeComponent=function(componentName,keepInMap){var c=this[componentName];if(!c){return}this.space.dispatchEvent("OnComponentUninitialized",c);c.destruct();var i,j,obj,listeners;for(i=0;i<c._listeners.length;++i){obj=c._listeners[i];listeners=this.space._events[obj.evt];for(j=0;listeners&&j<listeners.length;++j){if(listeners[j].self===obj.self&&listeners[j].func===obj.func){listeners.splice(j,1);break}}}var componentDef=TANK._registeredComponents[componentName];for(i=0;i<componentDef._interfaces.length;++i){var componentList=this.space._interfaceComponents[componentDef._interfaces[i]];if(componentList){delete componentList[this.name+"."+componentDef.name]}}if(!keepInMap){this._orderedComponents.splice(c._order,1);delete this._components[componentName];delete this[componentName]}};TANK.Entity.prototype.invoke=function(funcName){var message_args=[];var i;for(i=1;i<arguments.length;++i){message_args.push(arguments[i])}for(i in this._components){if(this._components.hasOwnProperty(i)&&this._components[i][funcName]&&this._components[i][funcName].apply){this._components[i][funcName].apply(this._components[i],message_args)}}return this};TANK.Entity.prototype.initialize=function(){var n,c;for(n in this._components){this.trackInterface(n)}for(n=0;n<this._orderedComponents.length;++n){c=this._orderedComponents[n];c.space=this.space;c.initialize()}for(n=0;n<this._orderedComponents.length;++n){c=this._orderedComponents[n];this.space.dispatchEvent("OnComponentInitialized",c)}this._initialized=true;return this};TANK.Entity.prototype.destruct=function(){var i;for(i=this._orderedComponents.length-1;i>=0;--i){this.removeComponent(this._orderedComponents[i].name,true)}this._initialized=false;return this};TANK.Entity.prototype.trackInterface=function(name){var c=this[name];var componentDef;componentDef=TANK._registeredComponents[name];for(var i=0;i<componentDef._interfaces.length;++i){var componentList=this.space._interfaceComponents[componentDef._interfaces[i]];if(!componentList){componentList={};this.space._interfaceComponents[componentDef._interfaces[i]]=componentList}componentList[this.name+"."+componentDef.name]=c}}})(this.TANK=this.TANK||{});(function(TANK){"use strict";TANK.Space=function(){this.name=null;this.space=this;this.paused=false;this._initialized=false;this._objects={};this._objectsNamed={};this._objectsDeleted=[];this._components={};this._orderedComponents=[];this._numComponents=0;this._interfaceComponents={};this._events={}};TANK.Space.prototype.addComponent=TANK.Entity.prototype.addComponent;TANK.Space.prototype.addComponents=TANK.Entity.prototype.addComponents;TANK.Space.prototype.removeComponent=TANK.Entity.prototype.removeComponent;TANK.Space.prototype.invoke=TANK.Entity.prototype.invoke;TANK.Space.prototype.destruct=TANK.Entity.prototype.destruct;TANK.Space.prototype.addEntity=function(object,name){if(object.id!==-1){TANK.error("Attempting to add a Entity twice");return object}object.id=TANK._currentID++;object.space=this;if(object.name===null){object.name="Entity "+object.id}if(name){object.name=name;if(this._objectsNamed[name]){TANK.error("An Entity named "+name+" already exists");return object}this._objectsNamed[name]=object}this._objects[object.id]=object;object.initialize();return object};TANK.Space.prototype.getEntity=function(idOrName){if(typeof idOrName==="string"){return this._objectsNamed[idOrName]}if(typeof idOrName==="number"){return this._objects[idOrName]}TANK.error("Attemping to get an Entity with neither a string name nor an id number: "+idOrName)};TANK.Space.prototype.removeEntity=function(arg){if(typeof arg==="string"||typeof arg==="number"){var entity=this.getEntity(arg);if(entity){this._objectsDeleted.push(this.getEntity(arg))}else{TANK.error("Attempting to remove Entity "+arg+" which doesn't exist.")}}else if(arg instanceof TANK.Entity){this._objectsDeleted.push(arg)}else{TANK.error("Attemping to remove an Entity with neither a string name, id number, or Entity reference: "+arg)}};TANK.Space.prototype.removeAllEntities=function(){var i;for(i in this._objects){if(this._objects.hasOwnProperty(i)){this.removeEntity(parseInt(i,10))}}};TANK.Space.prototype.getComponentsWithInterface=function(interfaceName){return this._interfaceComponents[interfaceName]};TANK.Space.prototype.dispatchEvent=function(eventName){var listeners=this._events[eventName];if(!listeners)return;var message_args=[];for(var i=1;i<arguments.length;++i)message_args.push(arguments[i]);var func,thisObj;for(var i in listeners){func=listeners[i].func;thisObj=listeners[i].self;if(func&&func.apply)func.apply(thisObj,message_args);else TANK.error(thisObj.name+" is listening for "+eventName+" but the supplied method is no longer valid")}};TANK.Space.prototype.clearDeletedObjects=function(){for(var i=0;i<this._objectsDeleted.length;++i){var obj=this._objectsDeleted[i];obj.destruct();delete this._objects[obj.id];delete this._objectsNamed[obj.name];obj.id=-1}this._objectsDeleted=[]};TANK.Space.prototype.update=function(dt){if(this.paused)return;for(var i=0;i<this._orderedComponents.length;++i){var c=this._orderedComponents[i];if(c.update)c.update(dt);this.dispatchEvent(c.name+"PostUpdate",dt)}this.dispatchEvent("OnEnterFrame",dt)}})(this.TANK=this.TANK||{});(function(TANK){"use strict";TANK.errorsEnabled=true;TANK.warningsEnabled=true;TANK.logsEnabled=true;TANK.createEntity=function(){var entity=new TANK.Entity(-1);return entity.addComponents.apply(entity,arguments)};TANK.createEntityFromPrefab=function(prefabName){var prefab=TANK.getPrefab(prefabName);if(!prefab){TANK.error("Could not find a prefab named "+prefabName);return}if(!prefab.apply){TANK.error("Prefab function supplied for "+prefabName+" is not a function: "+prefab);return}return prefab()};TANK.addEntity=TANK.Space.prototype.addEntity;TANK.getEntity=TANK.Space.prototype.getEntity;TANK.removeEntity=TANK.Space.prototype.removeEntity;TANK.removeAllEntities=TANK.Space.prototype.removeAllEntities;TANK.addComponent=TANK.Entity.prototype.addComponent;TANK.addComponents=TANK.Entity.prototype.addComponents;TANK.removeComponent=TANK.Entity.prototype.removeComponent;TANK.getComponentsWithInterface=TANK.Space.prototype.getComponentsWithInterface;TANK.initialize=TANK.Entity.prototype.initialize;TANK.destruct=TANK.Entity.prototype.destruct;TANK.invoke=TANK.Entity.prototype.invoke;TANK.dispatchEvent=TANK.Space.prototype.dispatchEvent;TANK.clearDeletedObjects=TANK.Space.prototype.clearDeletedObjects;TANK.trackInterface=TANK.Entity.prototype.trackInterface;TANK.update=TANK.Space.prototype.update;TANK.addPrefab=function(name,func){TANK._prefabs[name]=func};TANK.getPrefab=function(name){return TANK._prefabs[name]};TANK.registerComponent=function(componentName){if(componentName[0]>=0&&componentName[0]<=9||componentName.search(" ")>=0){TANK.error(componentName+" is an invalid identifier and won't be accessible without [] operator");return}var c=new TANK.Component(componentName);TANK._registeredComponents[componentName]=c;return c};TANK.start=function(){TANK._lastTime=new Date;TANK._running=true;TANK.initialize();TANK.log("TankJS has been started");update()};TANK.stop=function(){TANK._running=false};TANK.reset=function(entryPointFunc){TANK._entryPointFunc=entryPointFunc;TANK._resetting=true;TANK.removeAllEntities();for(var i in TANK._spaces){TANK._spaces[i].removeAllEntities()}};TANK.log=function(text){if(!TANK.logsEnabled)return;console.log(text)};TANK.warn=function(text){if(!TANK.warningsEnabled)return;console.warn(text)};TANK.error=function(text){if(!TANK.errorsEnabled)return;console.error(text)};function update(){var newTime=new Date;var dt=(newTime-TANK._lastTime)/1e3;TANK._lastTime=newTime;if(dt>.05)dt=.05;TANK.clearDeletedObjects();for(var i in TANK._spaces){if(TANK._spaces.hasOwnProperty(i)){TANK._spaces[i].clearDeletedObjects()}}if(TANK._resetting){TANK.destruct();for(var i in TANK._spaces){TANK._spaces[i].destruct();delete TANK[i]}TANK._spaces={};TANK._resetting=false;TANK._running=false;if(TANK._entryPointFunc)TANK._entryPointFunc();return}TANK.update(dt);for(var i in TANK._spaces){if(TANK._spaces.hasOwnProperty(i)){TANK._spaces[i].update(dt)}}if(TANK._running)requestAnimFrame(update)}TANK._prefabs={};TANK._spaces={};TANK._spacesDeleted=[];TANK._registeredComponents={};TANK._currentID=0;TANK._lastTime=new Date;TANK._running=false;TANK._resetting=false;TANK.name="TANK";TANK.space=TANK;TANK.paused=false;TANK._initialized=false;TANK._objects={};TANK._objectsNamed={};TANK._objectsDeleted=[];TANK._components={};TANK._orderedComponents=[];TANK._numComponents=0;TANK._interfaceComponents={};TANK._events={}})(this.TANK=this.TANK||{});